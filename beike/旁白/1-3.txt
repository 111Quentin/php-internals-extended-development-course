大家好，这节课我们来讲一下php中的SAPI的概念



PHP可以不同环境下和不同软件配合工作，比较常见的比如可以在终端命令行直接执行，或者以fpm模式和nginx配合使用,或者可以配置为apache模块执行等。

对应的大家也可以看到PHP源代码的sapi目录，这里有具体的一些实现文件夹

PHP和这些不同的软件配合，须要有一套机制和其它应用程序进行交互和协作。这一套机制就被称为是SAPI





举个例子，比如我们要运行这个test.php文件，这里面有两行代码...

大家都知道$_POST变是是PHP为你事先自动为你准备好了的，大家思考一下，在fpm和nginx配合的情况下这个post数据要如何生成，
在终端命令行要如何生成，这里获取POST的方法肯定是不一样的。


同样的，第二行代码的打印输出变量，要打印到哪里，输出到浏览器还是终端，这也是PHP需要区别对待的。


所以PHP为它们设计了sapi_module_struct的结构体，来配置定义这些模式中不同的行为。










我们看这个结构体的名字SAPI模块结构体，每个SAPI的实现都会对应一个这样的结构体，


我们来搜索一下看哪里用到了这个结构体












每个SAPI的实现都定义了一个sapi_module_struct结构体.

我们就在代码中搜索一下这个结构体来看一下。



sapi.h中是这个结构体的定义、

每个SAPI的实现目录中都定义了一个这个结构体类型的变量。



我们来看一下这个结构体中具体有哪些成员以及他们的作用是什么。











我们在代码中看一下不同的SAPI的定义


可以看到不同的SAPI里的函数指定成员，被定义为了不同的函数


按住ctrl点左键或者按F3可以查看目标的具体定义


返回



最后我们下个断点验证一下，这个函数是不是被调用了。



听不懂不要紧，自己练习一下，可以往下面继续听





















这么多代码如何学习?

你可以一步一步调试执行，一行一行研究它的实现，这是一个不太科学的方法。

我们这里先学习它的整体思想，然后讲再把它重要的点逐个讲一下，它再多的代码我们再研究起来也会脑子里有思路了。






我们先来讲一下一个最基本的PHP输入输出过程，CLI模式下面输出hello world

执行php -r "echo hello world" 这代码之后PHP会做什么事情



讲之前我们先了解一个概念:PHP里的SAPI是什么意思。



调试一下什么时候调用了sapi_module.ub_write(context.out.data, context.out.used);





我们看一下这个结构体，
我们看一下哪里用到了这个结构体，ctrl+alt+g











首先任何可执行的C程序都需要一个main函数，PHP也不例外

PHP的main函数里面主要执行了以下几步



























































